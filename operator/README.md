<!-- TOC -->
- [PMEM-CSI Operator](#pmem-csi-for-kubernetes)
  - [About](#about)
  - [Usage](#usage)
    - [Pre-requisites](#pre-requisites)
    - [Deploy PMEM-CSI operator](#deploy-pmem-csi-operator)
    - [Deployment CRD API](#deployment-crd-api)
  - [Example Deployment](#example-deployment)

<!-- /TOC -->
# PMEM-CSI-Operator

## About

Kubernetes operator for [PMEM-CSI](https://github.com/intel/pmem-csi) driver deployment. Using this operator one can easily deploy and manage PMEM-CSI driver in a Kubernetes cluster.

The PMEM-CSI operator is based on the CoreOS [operator-sdk](https://github.com/operator-framework/operator-sdk) tools and APIs.

## Usage

### Pre-requisites

A running Kubernetes cluster with one or more nodes installed with PMEM hardware(NVDIMM). The persistent memory on these nodes must be [pre-provisioned](../README.md#persistent-memory-pre-provisioning).

### Deploy PMEM-CSI operator

<!-- The assumptions:
  a) pmem-csi-operator binary is part of released intel/pmem-csi-driver image and no additional steps required to build the images
-->

```sh
$ kubectl create -f https://raw.githubusercontent.com/intel/pmem-csi/operator/operator/deploy/operator.yaml
```

### Deployment CRD API

Current PMEM-CSI Deployment object supports below API:

#### Deployment

|Field | type | Description |
|---|---|---|
| apiVersion | string  | `pmem-csi.intel.com/v1alpha1`|
| kind | string | `Deployment`|
| metadata | [ObjectMeta](https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status) | Standard objects metadata |
| spec | [DeploymentSpec](#deployment-spec) | Specification of the desired behavior of the deployment |

#### DeploymentSpec

|Field | type | Description | Default Value |
|---|---|---|---|
| driverName | string | Unique CSI driver name to use | `pmem-csi.intel.com` |
| image | string | PMEM-CSI docker image name used for the deployment | `intel/pmem-csi-driver:canary` |
| provisionerImage | string | [CSI provisioner](https://github.com/kubernetes-csi/external-provisioner) docker image name | `quay.io/k8scsi/csi-provisioner:v1.2.1` |
| registrarImage | string | [CSI node driver registrar](https://github.com/kubernetes-csi/node-driver-registrar) docker image name | `quay.io/k8scsi/csi-node-driver-registrar:v1.1.0` |
| pullPolicy | string | Docker image pull policy. either one of `Always`, `Never`, `IfNotPresent` | `IfNotPresent` |
| logLevel | integer | PMEM-CSI driver logging level | 3 |
| deviceMode | string | Device management mode to use. Supports one of `lvm` or `direct` | `lvm`
| controllerResources | [ResourceRequirements](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core) | Describes the compute resource requirements for controller pod |
| nodeResources | [ResourceRequirements](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core) | Describes the compute resource requirements for the pods running on node(s) |
| nodeSelector | string map | [Labels to use for selecting Nodes](../README.md#run-pmem-csi-on-kubernetes) on which PMEM-CSI driver should run. | `{Â "storage": "pmem" }`

#### DeploymentStatus

A PMEM-CSI Deployment's `status` field is a `DeploymentStatus` object, which has
a `phase` field. The phase of a Deployment is high-level summary of where the
Deployment is in it's lifecycle.

The possible `phase` values and their meaning are as below:

| value | meaning |
|---|---|---|
| Pending | The `Deployment` has been accepted by the system, but waiting for one or more of it's pre-requisites to be completed. Such as waiting for required [TLS certificates](../README.md#security) to be generated |
| Initializing | The required sub-resources of the `Deployment` are being initialized |
| Running | All the required sub-resources of the `Deployment` are created |
| Failed | For some reason the state of the `Deployment` failed and cannot be progressed |

### TLS Certificate approval

All PMEM-CSI driver communication is protected by mutual TLS. So the driver
deployment needs to generate those certificates. The operator uses Certificate
Authority(CA) provided by the Kubernetes cluster to get those certificates. On a
new deployment, the operator creates Kubernetes `CertificateSigningRequest`
objects and keeps the deployment in `pending` state till those CSRs get approved
by an authorized user so that Kubernetes CA could generate the certificates.
Once the CSRs are approved and certificates are ready, then the deployment
process gets progressed.

If the operator is configured with appropriate RBAC rules with enough
permissions to approve CSRs, the operator itself runs a dedicated certificate
approval control-loop, that detects and approves the certificate signing
requests generated by a PMEM-CSI Deployment. For validating if a CSR is
generated by the operator it uses the `Username` field of
`CertificateSigningRequestSpec`.


## Example Deployment

Once the [operator deployed](#deploy-PMEM-CSI-operator) is in `Running` state, it is ready to handle PMEM-CSI `Deployment` objects in `pmem-csi.intel.com` API group.

Here is an example driver deployment with custom driver image and pod resources:

```sh
$ kubectl create -f - <<EOF
apiVersion: pmem-csi.intel.com/v1alpha1
kind: Deployment
metadata:
  name: pmem-deployment
spec:
  image: localhost/pmem-csi-driver:canary
  deviceMode: lvm
  controllerResources:
    requests:
      cpu: "200m"
      memory: "100Mi"
  nodeResources:
    requests:
      cpu: "200m"
      memory: "100Mi"
EOF
```

Once the above deployment installation is successful, we can see all the driver
pods in `Running` state:
```sh
$ kubectl get deployments.pmem-csi.intel.com
NAME                 AGE
pmem-deployment      50s

$ kubectl describe deployment.pmem-csi.intel.com pmem-deployment
Name:         pmem-deployment
Namespace:    default
Labels:       <none>
Annotations:  <none>
API Version:  pmem-csi.intel.com/v1alpha1
Kind:         Deployment
Metadata:
  Creation Timestamp:  2020-01-23T13:40:32Z
  Generation:          1
  Resource Version:    3596387
  Self Link:           /apis/pmem-csi.intel.com/v1alpha1/namespaces/default/deployments/pmem-deployment
  UID:                 454b5961-5aa2-41c3-b774-29fe932ae236
Spec:
  Controller Resources:
    Requests:
      Cpu:      200m
      Memory:   100Mi
  Device Mode:  lvm
  Image:        localhost/pmem-csi-driver:canary
  Node Resources:
    Requests:
      Cpu:     200m
      Memory:  100Mi
Status:
  Phase:  Running
Events:   <none>


$ kubectl get po
NAME                    READY   STATUS    RESTARTS   AGE
pmem-deployment-controller-0   2/2     Running   0          51s
pmem-deployment-node-4x7cv     2/2     Running   0          50s
pmem-deployment-node-6grt6     2/2     Running   0          50s
pmem-deployment-node-msgds     2/2     Running   0          51s
```

> **Note on multiple deployments**
>
> Though the operator allows running multiple PMEM-CSI driver deployments, one
> has to take extreme care of such deployments by ensuring that not more than
> one driver ends up running on the same node(s). Nodes on which a PMEM-CSI
> driver could run can be configured by using `nodeSelector` property of
> [`DeploymentSpec`](#deployment-crd-api).
