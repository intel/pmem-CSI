<!-- TOC -->
- [PMEM-CSI Operator](#pmem-csi-for-kubernetes)
  - [About](#about)
  - [Usage](#usage)
    - [Pre-requisites](#pre-requisites)
    - [Deploy PMEM-CSI operator](#deploy-pmem-csi-operator)
    - [Deployment CRD API](#deployment-crd-api)
    - [Driver certificates](#driver-certificates)
  - [Example Deployment](#example-deployment)

<!-- /TOC -->
# PMEM-CSI operator

## About

PMEM-CSI operator facilitates deploying and managing the [PMEM-CSI driver](https://github.com/intel/pmem-csi) on a Kubernetes cluster. 

This operator is based on the CoreOS [operator-sdk](https://github.com/operator-framework/operator-sdk) tools and APIs.

## Usage

### Pre-requisites

A running Kubernetes cluster with one or more nodes installed with PMEM hardware(NVDIMM). The persistent memory on these nodes must be [pre-provisioned](../README.md#persistent-memory-pre-provisioning).

### Deploy PMEM-CSI operator

<!-- The assumptions:
  a) pmem-csi-operator binary is part of released intel/pmem-csi-driver image and no additional steps required to build the images
-->
<!--
  TODOs: Changes to below URL
    1) Current url is referring to 'operator' branch. so, when moved to devel branch change the url accordingly: 'raw/operator' ->  'raw/devel'
    2) Though currently operator deployments are in 'REPO_ROOT/operator/deploy', they must moved to 'REPO_ROOT/deploy'. Then that change should reflect in this url : 'operator/deploy' -> '/deploy'
    3) In release branch, branch name part of the url should point to appropriate release branch name
-->
```sh
$ kubectl create -f https://github.com/intel/pmem-csi/raw/operator/operator/deploy/operator.yaml
```

### Deployment CRD API

`Deployment` is a cluster-scoped Kubernetes resource in the
`pmem-csi.intel.com` API group. It describes how a PMEM-CSI driver
instance is to be created.

The operator will create objects in the namespace in which the
operator itself runs unless the object type is not namespaced.

The current API for PMEM-CSI `Deployment` resources is:

#### Deployment

|Field | type | Description |
|---|---|---|
| apiVersion | string  | `pmem-csi.intel.com/v1alpha1`|
| kind | string | `Deployment`|
| metadata | [ObjectMeta](https://git.k8s.io/community/contributors/devel/api-conventions.md#spec-and-status) | Standard objects metadata |
| spec | [DeploymentSpec](#deployment-spec) | Specification of the desired behavior of the deployment |

#### DeploymentSpec

|Field | type | Description | Default Value |
|---|---|---|---|
| driverName | string | Unique CSI driver name to use | `pmem-csi.intel.com` |
| image | string | PMEM-CSI docker image name used for the deployment | the same image as the operator<sup>1</sup> |
| provisionerImage | string | [CSI provisioner](https://kubernetes-csi.github.io/docs/external-provisioner.html) docker image name | latest [external provisioner](https://kubernetes-csi.github.io/docs/external-provisioner.html) stable release image<sup>2</sup> |
| registrarImage | string | [CSI node driver registrar](https://github.com/kubernetes-csi/node-driver-registrar) docker image name | latest [node driver registrar](https://kubernetes-csi.github.io/docs/node-driver-registrar.html) stable release image<sup>2</sup> |
| pullPolicy | string | Docker image pull policy. either one of `Always`, `Never`, `IfNotPresent` | `IfNotPresent` |
| logLevel | integer | PMEM-CSI driver logging level | 3 |
| deviceMode | string | Device management mode to use. Supports one of `lvm` or `direct` | `lvm`
| controllerResources | [ResourceRequirements](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core) | Describes the compute resource requirements for controller pod |
| nodeResources | [ResourceRequirements](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.12/#resourcerequirements-v1-core) | Describes the compute resource requirements for the pods running on node(s) |
| registryCert | string | Encoded tls certificate signed by a certificate authority used for driver's controller registry server | generated by operator self-signed CA |
| nodeControllerCert | string | Encoded tls certificate signed by a certificate authority used for driver's node controllers | generated by operator self-signed CA |
| registryKey | string | Encoded RSA private key used for signing by `registryCert` | generated by the operator |
| nodeControllerKey | string | Encoded RSA private key used for signing by `nodeControllerCert` | generated by the operator |
| caCert | string | Certificate of the CA by which the `registryCert` and `controllerCert` are signed | self-signed certificate generated by the operator |
| nodeSelector | string map | [Labels to use for selecting Nodes](../README.md#run-pmem-csi-on-kubernetes) on which PMEM-CSI driver should run. | `{Â "storage": "pmem" }`|
| pmemPercentage | integer | Percentage of PMEM space to be used by the driver on each node. This is only valid for a driver deployed in `lvm` mode. This field cannot be changed of a running deployment. | 100 |
| labels | string map | Additional labels for all objects created by the operator. Can only be set when creating the deployment. |

<sup>1</sup> To use the same container image as default driver image
the operator pod must set with below environment variables with
appropriate values:
 - POD_NAME: Name of the operator pod. Namespace of the pod could be figured out by the operator.
 - OPERATOR_NAME: Name of the operator container. If not set, defaults to "pmem-csi-operator"

<sup>2</sup> Image versions depend on the Kubernetes release. The
operator dynamically chooses suitable image versions. Users have to
take care of that themselves when overriding the values.

#### DeploymentStatus

A PMEM-CSI Deployment's `status` field is a `DeploymentStatus` object, which has
a `phase` field. The phase of a Deployment is high-level summary of where the
Deployment is in it's lifecycle.

The possible `phase` values and their meaning are as below:

| value | meaning |
|---|---|
| empty string | A new deployment. |
| Initializing | All the direct sub-resources of the `Deployment` are created, but some indirect ones (like pods controlled by a daemon set) may still be missing. |
| Running | The operator has determined that the driver is usable<sup>1</sup>.  |
| Failed | For some reason the state of the `Deployment` failed and cannot be progressed<sup>2</sup>. |

<sup>1</sup> This check has not been implemented yet. Instead, the deployment goes straight to `Running` after creating sub-resources.
<sup>2</sup> Failure reason is supposed to be carried by one of additional `DeploymentStatus` field, but not implemented yet.

### Driver certificates

All [PMEM-CSI driver communication is protected by mutual
TLS](../README.md#security) to ensure that malicious or compromised entities in
the cluster cannot interfere with its operation. So the driver deployment needs
to be provided with those certificates and corresponding private keys using appropriate fields in deployment specification. These encoded certificates and private keys are made available to driver pods via Kubernetes [secrets](https://kubernetes.io/docs/concepts/configuration/secret/) by the operator.

If the private keys and/or certificates data is missing in a deployment, the operator generates them using a self-signed CA.

**NOTE:** A production deployment that is not supposed to depend on the operator's self-signed CA instead must provide the certificates generated from a trusted certificate authority.

## Example Deployment

Once the [operator deployed](#deploy-PMEM-CSI-operator) is in `Running` state, it is ready to handle PMEM-CSI `Deployment` objects in `pmem-csi.intel.com` API group.

Here is an example driver deployment with custom driver image and pod resources:

```sh
$ kubectl create -f - <<EOF
apiVersion: pmem-csi.intel.com/v1alpha1
kind: Deployment
metadata:
  name: pmem-deployment
spec:
  image: localhost/pmem-csi-driver:canary
  deviceMode: lvm
  controllerResources:
    requests:
      cpu: "200m"
      memory: "100Mi"
  nodeResources:
    requests:
      cpu: "200m"
      memory: "100Mi"
EOF
```

Once the above deployment installation is successful, we can see all the driver
pods in `Running` state:
```sh
$ kubectl get deployments.pmem-csi.intel.com
NAME                 AGE
pmem-deployment      50s

$ kubectl describe deployment.pmem-csi.intel.com pmem-deployment
Name:         pmem-deployment
Namespace:    default
Labels:       <none>
Annotations:  <none>
API Version:  pmem-csi.intel.com/v1alpha1
Kind:         Deployment
Metadata:
  Creation Timestamp:  2020-01-23T13:40:32Z
  Generation:          1
  Resource Version:    3596387
  Self Link:           /apis/pmem-csi.intel.com/v1alpha1/deployments/pmem-deployment
  UID:                 454b5961-5aa2-41c3-b774-29fe932ae236
Spec:
  Controller Resources:
    Requests:
      Cpu:      200m
      Memory:   100Mi
  Device Mode:  lvm
  Image:        localhost/pmem-csi-driver:canary
  Node Resources:
    Requests:
      Cpu:     200m
      Memory:  100Mi
Status:
  Phase:  Running
Events:   <none>


$ kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
pmem-deployment-controller-0       2/2     Running   0          51s
pmem-deployment-node-4x7cv         2/2     Running   0          50s
pmem-deployment-node-6grt6         2/2     Running   0          50s
pmem-deployment-node-msgds         2/2     Running   0          51s
pmem-csi-operator-749c7c7c69-k5k8n 1/1     Running   0          3m
```

> **Note on multiple deployments**
>
> Though the operator allows running multiple PMEM-CSI driver deployments, one
> has to take extreme care of such deployments by ensuring that not more than
> one driver ends up running on the same node(s). Nodes on which a PMEM-CSI
> driver could run can be configured by using `nodeSelector` property of
> [`DeploymentSpec`](#deployment-crd-api).
